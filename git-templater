#!/usr/bin/env bash

set -e

usage() {
    cat <<EOF
Usage: git-templater <command> [options]

Commands:
    list <template-repo>
        List all branches in the template repository

    apply <template-repo> <target-dir> <branch...>
        Apply feature branches from template repo to target directory

Examples:
    git-templater list ./templates
    git-templater apply ./templates ./my-project feature/auth/google feature/auth/github
EOF
    exit 1
}

list_branches() {
    local template_repo="$1"
    
    if [[ ! -d "$template_repo/.git" ]]; then
        echo "Error: $template_repo is not a git repository"
        exit 1
    fi
    
    echo "Available branches in $template_repo:"
    echo
    git -C "$template_repo" branch -a | sed 's/^..//' | grep -v 'HEAD' | sort
}

apply_branches() {
    local template_repo="$1"
    local target_dir="$2"
    shift 2
    local branches=("$@")
    
    if [[ ! -d "$template_repo/.git" ]]; then
        echo "Error: $template_repo is not a git repository"
        exit 1
    fi
    
    if [[ ${#branches[@]} -eq 0 ]]; then
        echo "Error: No branches specified"
        usage
    fi
    
    # Get absolute path to template repo
    template_repo=$(cd "$template_repo" && pwd)
    
    # Create target directory if it doesn't exist
    mkdir -p "$target_dir"
    cd "$target_dir"
    
    # Initialize git repo if needed
    if [[ ! -d ".git" ]]; then
        echo "Initializing git repository in $target_dir"
        git init
        git config user.name "Templater"
        git config user.email "templater@local"
        git commit --allow-empty -m "Initial commit"
    else
        # Check for dirty working tree
        if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "Error: Target directory has uncommitted changes"
            echo "Commit or stash them before applying templates"
            exit 1
        fi
    fi
    
    # Add template repo as remote
    if git remote | grep -q "^templates$"; then
        git remote remove templates
    fi
    git remote add templates "$template_repo"
    
    # Fetch branches
    echo "Fetching branches from $template_repo"
    git fetch templates
    
    # Merge each branch
    for branch in "${branches[@]}"; do
        echo "Merging templates/$branch..."
        if ! git merge "templates/$branch" -m "Applied $branch"; then
            echo "Error: Failed to merge $branch"
            echo "Conflicts detected. Resolve them manually or abort with: git merge --abort"
            exit 1
        fi
    done
    
    echo
    echo "Successfully applied ${#branches[@]} feature(s)"
}

# Main
if [[ $# -lt 1 ]]; then
    usage
fi

command="$1"
shift

case "$command" in
    list)
        if [[ $# -ne 1 ]]; then
            usage
        fi
        list_branches "$1"
        ;;
    apply)
        if [[ $# -lt 3 ]]; then
            usage
        fi
        apply_branches "$@"
        ;;
    *)
        echo "Error: Unknown command '$command'"
        usage
        ;;
esac
