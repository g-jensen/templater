name: "apply from file"
description: "Apply features listed in a file"

before_each:
  run: |
    mkdir -p ${SCENARIO_OUTPUT}/templates/auth/oauth/google
    mkdir -p ${SCENARIO_OUTPUT}/templates/auth/oauth/github
    mkdir -p ${SCENARIO_OUTPUT}/templates/database
    mkdir -p ${SCENARIO_OUTPUT}/target
    cat > ${SCENARIO_OUTPUT}/templates/auth/base.patch << 'EOF'
    diff --git a/auth.txt b/auth.txt
    new file mode 100644
    --- /dev/null
    +++ b/auth.txt
    @@ -0,0 +1 @@
    +auth feature
    EOF
    cat > ${SCENARIO_OUTPUT}/templates/auth/oauth/base.patch << 'EOF'
    diff --git a/oauth.txt b/oauth.txt
    new file mode 100644
    --- /dev/null
    +++ b/oauth.txt
    @@ -0,0 +1 @@
    +oauth feature
    EOF
    cat > ${SCENARIO_OUTPUT}/templates/auth/oauth/google/base.patch << 'EOF'
    diff --git a/google.txt b/google.txt
    new file mode 100644
    --- /dev/null
    +++ b/google.txt
    @@ -0,0 +1 @@
    +google oauth
    EOF
    cat > ${SCENARIO_OUTPUT}/templates/auth/oauth/github/base.patch << 'EOF'
    diff --git a/github.txt b/github.txt
    new file mode 100644
    --- /dev/null
    +++ b/github.txt
    @@ -0,0 +1 @@
    +github oauth
    EOF
    cat > ${SCENARIO_OUTPUT}/templates/database/base.patch << 'EOF'
    diff --git a/database.txt b/database.txt
    new file mode 100644
    --- /dev/null
    +++ b/database.txt
    @@ -0,0 +1 @@
    +database feature
    EOF
  timeout: 5s

scenarios:
  - id: apply_from_features_file
    name: "Apply features listed in file"
    before:
      run: |
        cat > ${SCENARIO_OUTPUT}/features.txt << 'EOF'
        auth/oauth/google
        auth/oauth/github
        database
        EOF
      timeout: 5s
    run:
      command: ${TEMPLATER} apply ${SCENARIO_OUTPUT}/templates ${SCENARIO_OUTPUT}/target -f ${SCENARIO_OUTPUT}/features.txt
      timeout: 10s
    assertions:
      - command: assert_contains "Applied 5 features" ${RUN_OUTPUT}/stdout
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code
      - command: assert_equals "auth feature" ${SCENARIO_OUTPUT}/target/auth.txt
      - command: assert_equals "oauth feature" ${SCENARIO_OUTPUT}/target/oauth.txt
      - command: assert_equals "google oauth" ${SCENARIO_OUTPUT}/target/google.txt
      - command: assert_equals "github oauth" ${SCENARIO_OUTPUT}/target/github.txt
      - command: assert_equals "database feature" ${SCENARIO_OUTPUT}/target/database.txt

  - id: empty_lines_ignored
    name: "Empty lines in features file are ignored"
    before:
      run: |
        cat > ${SCENARIO_OUTPUT}/features.txt << 'EOF'
        auth

        database
        EOF
      timeout: 5s
    run:
      command: ${TEMPLATER} apply ${SCENARIO_OUTPUT}/templates ${SCENARIO_OUTPUT}/target -f ${SCENARIO_OUTPUT}/features.txt
      timeout: 10s
    assertions:
      - command: assert_contains "Applied 2 features" ${RUN_OUTPUT}/stdout
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code

  - id: cannot_mix_file_and_args
    name: "Cannot mix -f with positional feature arguments"
    before:
      run: |
        echo "auth" > ${SCENARIO_OUTPUT}/features.txt
      timeout: 5s
    run:
      command: ${TEMPLATER} apply ${SCENARIO_OUTPUT}/templates ${SCENARIO_OUTPUT}/target -f ${SCENARIO_OUTPUT}/features.txt database
      timeout: 5s
    assertions:
      - command: assert_contains "cannot" ${RUN_OUTPUT}/stderr
      - command: assert_gt ${RUN_OUTPUT}/exit_code 0

  - id: nonexistent_features_file
    name: "Nonexistent features file returns error"
    run:
      command: ${TEMPLATER} apply ${SCENARIO_OUTPUT}/templates ${SCENARIO_OUTPUT}/target -f ${SCENARIO_OUTPUT}/nonexistent.txt
      timeout: 5s
    assertions:
      - command: assert_contains "not found" ${RUN_OUTPUT}/stderr
      - command: assert_gt ${RUN_OUTPUT}/exit_code 0
