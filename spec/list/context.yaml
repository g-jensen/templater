name: "list command"
description: "Display available features as an ASCII tree"

before_each:
  run: |
    mkdir -p ${SCENARIO_OUTPUT}/templates
    mkdir -p ${SCENARIO_OUTPUT}/target
  timeout: 5s

scenarios:
  - id: empty_template_repo
    name: "Empty template repo shows nothing"
    run:
      command: ${TEMPLATER} list ${SCENARIO_OUTPUT}/templates
      timeout: 5s
    assertions:
      - command: assert_equals "" ${RUN_OUTPUT}/stdout
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code

  - id: single_feature
    name: "Single feature at root level"
    before:
      run: |
        mkdir -p ${SCENARIO_OUTPUT}/templates/auth
        touch ${SCENARIO_OUTPUT}/templates/auth/base.patch
      timeout: 5s
    run:
      command: ${TEMPLATER} list ${SCENARIO_OUTPUT}/templates
      timeout: 5s
    assertions:
      - command: assert_equals single_feature.fixture ${RUN_OUTPUT}/stdout
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code

  - id: nested_features
    name: "Nested feature tree displays correctly"
    before:
      run: |
        mkdir -p ${SCENARIO_OUTPUT}/templates/auth/oauth/google
        mkdir -p ${SCENARIO_OUTPUT}/templates/auth/oauth/github
        mkdir -p ${SCENARIO_OUTPUT}/templates/database/migrations
        touch ${SCENARIO_OUTPUT}/templates/auth/base.patch
        touch ${SCENARIO_OUTPUT}/templates/auth/oauth/base.patch
        touch ${SCENARIO_OUTPUT}/templates/auth/oauth/google/base.patch
        touch ${SCENARIO_OUTPUT}/templates/auth/oauth/github/base.patch
        touch ${SCENARIO_OUTPUT}/templates/database/base.patch
        touch ${SCENARIO_OUTPUT}/templates/database/migrations/base.patch
      timeout: 5s
    run:
      command: ${TEMPLATER} list ${SCENARIO_OUTPUT}/templates
      timeout: 5s
    assertions:
      - command: assert_equals nested_features.fixture ${RUN_OUTPUT}/stdout
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code

  - id: with_root_patch
    name: "Root base.patch is not shown in tree"
    before:
      run: |
        mkdir -p ${SCENARIO_OUTPUT}/templates/auth
        touch ${SCENARIO_OUTPUT}/templates/base.patch
        touch ${SCENARIO_OUTPUT}/templates/auth/base.patch
      timeout: 5s
    run:
      command: ${TEMPLATER} list ${SCENARIO_OUTPUT}/templates
      timeout: 5s
    assertions:
      - command: assert_equals single_feature.fixture ${RUN_OUTPUT}/stdout
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code

  - id: directories_without_patch_ignored
    name: "Directories without base.patch are ignored"
    before:
      run: |
        mkdir -p ${SCENARIO_OUTPUT}/templates/auth
        mkdir -p ${SCENARIO_OUTPUT}/templates/docs
        touch ${SCENARIO_OUTPUT}/templates/auth/base.patch
      timeout: 5s
    run:
      command: ${TEMPLATER} list ${SCENARIO_OUTPUT}/templates
      timeout: 5s
    assertions:
      - command: assert_equals single_feature.fixture ${RUN_OUTPUT}/stdout
      - command: assert_equals 0 ${RUN_OUTPUT}/exit_code

  - id: nonexistent_directory
    name: "Nonexistent template repo returns error"
    run:
      command: ${TEMPLATER} list ${SCENARIO_OUTPUT}/nonexistent
      timeout: 5s
    assertions:
      - command: assert_contains "not found" ${RUN_OUTPUT}/stderr
      - command: assert_gt ${RUN_OUTPUT}/exit_code 0
